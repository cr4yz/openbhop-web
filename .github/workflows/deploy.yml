name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- CACHE LAYER 1: C++ & Emscripten ---
      - name: Install ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache
          # Configure ccache size and directory
          ccache --set-config=max_size=500M

      - name: Cache C++ Build and Emscripten Libs
        uses: actions/cache@v4
        with:
          # Cache both the ccache directory and emscripten's system ports
          path: |
            ~/.ccache
            ~/.emscripten_cache
          # Key includes OS and a hash of your CMakeLists to reset if config changes
          key: ${{ runner.os }}-wasm-build-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-wasm-build-

      # --- CACHE LAYER 2: DXC Tool ---
      - name: Cache DXC Tool
        id: cache-dxc
        uses: actions/cache@v4
        with:
          path: linux_dxc_2023_08_14.x86_64.tar.gz
          key: dxc-release-v1.7.2308

      # 1. Install Dependencies (Ninja & DXC)
      - name: Install Ninja & DXC
        run: |
          sudo apt-get install -y ninja-build
          
          # Only download if not found in cache
          if [ ! -f "linux_dxc_2023_08_14.x86_64.tar.gz" ]; then
             wget https://github.com/microsoft/DirectXShaderCompiler/releases/download/v1.7.2308/linux_dxc_2023_08_14.x86_64.tar.gz
          fi
          
          tar xvf linux_dxc_2023_08_14.x86_64.tar.gz
          sudo cp bin/dxc /usr/local/bin/
          sudo chmod +x /usr/local/bin/dxc
          sudo cp lib/libdxcompiler.so /usr/local/lib/
          dxc --version

      # 2. Setup Emscripten
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      # 3. Build WASM Game (With Incremental Flags)
      - name: Build WASM Game
        run: |
          cd game-src
          
          # 1. We tell CMake to use ccache as a launcher
          # 2. We use -DEMSCRIPTEN=1 explicitly if needed, but emcmake usually handles it
          emcmake cmake -S . -B build-web -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DRMLUI_SHARED=OFF \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_EXE_LINKER_FLAGS="-sGL_ENABLE_GET_PROC_ADDRESS=1"
          
          cmake --build build-web

      # --- CACHE LAYER 3: Node Modules ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # This automatically handles package-lock.json hashing

      # 4. Build Vite Website
      - name: Build Vite Site
        run: |
          npm install
          npm run build

      # 5. Merge Game into Website
      - name: Copy Game Files to Dist
        run: |
           cp game-src/build-web/index.js dist/bh.js
           cp game-src/build-web/index.wasm dist/index.wasm
           # cp game-src/build-web/bh.data dist/ || true

      # 6. Upload to GitHub Pages
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4