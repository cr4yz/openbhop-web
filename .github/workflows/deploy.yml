jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # 1. DEFINE EXACT CACHE LOCATIONS
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      EM_CACHE: ${{ github.workspace }}/.emscripten_cache

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Ninja & ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ccache
          # Ensure ccache dir exists immediately so cache action doesn't complain on restore
          mkdir -p $CCACHE_DIR
          ccache --set-config=max_size=500M

      # 2. CACHE USING THE ENV VARIABLES
      - name: Cache C++ and Emscripten
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.EM_CACHE }}
          # Bumped key to 'v2' to ensure we start fresh with correct paths
          key: v2-${{ runner.os }}-wasm-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            v2-${{ runner.os }}-wasm-

      - name: Cache DXC Tool
        id: cache-dxc
        uses: actions/cache@v4
        with:
          path: linux_dxc_2023_08_14.x86_64.tar.gz
          key: dxc-release-v1.7.2308

      - name: Install DXC
        run: |
          if [ ! -f "linux_dxc_2023_08_14.x86_64.tar.gz" ]; then
             wget https://github.com/microsoft/DirectXShaderCompiler/releases/download/v1.7.2308/linux_dxc_2023_08_14.x86_64.tar.gz
          fi
          tar xvf linux_dxc_2023_08_14.x86_64.tar.gz
          sudo cp bin/dxc /usr/local/bin/
          sudo chmod +x /usr/local/bin/dxc
          sudo cp lib/libdxcompiler.so /usr/local/lib/

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Build WASM Game
        run: |
          cd game-src
          
          # 3. VERIFY DIRS EXIST (Optional safety check)
          mkdir -p $CCACHE_DIR
          mkdir -p $EM_CACHE

          emcmake cmake -S . -B build-web -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DRMLUI_SHARED=OFF \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_EXE_LINKER_FLAGS="-sGL_ENABLE_GET_PROC_ADDRESS=1"
          
          cmake --build build-web
          
          # 4. PRINT STATS (To verify ccache is actually working)
          ccache -s

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Build Vite Site
        run: |
          npm install
          npm run build

      - name: Copy Game Files to Dist
        run: |
           cp game-src/build-web/index.js dist/bh.js
           cp game-src/build-web/index.wasm dist/index.wasm
           cp game-src/build-web/index.data dist/index.data

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4